generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  ADMIN
  SUPERVISOR
  APROVADOR     // Deprecated: Migrating to N2
  APROVADOR_N1  // New Level 1
  APROVADOR_N2  // New Level 2 (Final)
  FINANCEIRO
  ENCARREGADO
  RH
}

enum StatusCobertura {
  PENDENTE
  AJUSTE
  APROVADO_N1   // Approved by Level 1, waiting for Level 2
  APROVADO      // Final approval (Level 2)
  REPROVADO
  PAGO
  CANCELADO
}

// Auth & Users
model User {
  id        String   @id @default(uuid())
  nome      String
  email     String   @unique
  password  String   // Simple auth for V1
  role      Role     @default(SUPERVISOR)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relationships
  coberturasLancadas  Cobertura[] @relation("SupervisorLancamento")
  coberturasAprovadasN1 Cobertura[] @relation("AprovadorN1Acao")
  coberturasAprovadas Cobertura[] @relation("AprovadorAcao")
  coberturasPagas     Cobertura[] @relation("FinanceiroAcao")
  anexos              Anexo[]
  historico           HistoricoWorkflow[]
  
  postosAutorizados   Posto[]
}

// Catalogs
model Posto {
  id    String  @id @default(uuid())
  nome  String
  ativo Boolean @default(true)
  coberturas Cobertura[]
  
  supervisores User[]
}

model Diarista {
  id    String  @id @default(uuid())
  nome  String
  cpf   String? @unique // Added for uniqueness verification
  chavePix String? 
  ativo Boolean @default(true)
  coberturas Cobertura[]
}

model Reserva {
  id    String  @id @default(uuid())
  nome  String  // Quem foi coberto (Banco de Reservas)
  cpf   String? @unique // Added for uniqueness verification
  ativo Boolean @default(true)
  coberturas Cobertura[]
}

model Motivo {
  id        String  @id @default(uuid())
  descricao String
  ativo     Boolean @default(true)
  coberturas Cobertura[]
}

model CargaHoraria {
  id        String  @id @default(uuid())
  descricao String  // Ex: 06:00, 08:00
  ativo     Boolean @default(true)
  coberturas Cobertura[]
}

model MeioPagamento {
  id        String  @id @default(uuid())
  descricao String  // PIX, Dinheiro, etc.
  ativo     Boolean @default(true)
  
  coberturasSolicitadas Cobertura[] @relation("MeioSolicitado")
  coberturasEfetivadas  Cobertura[] @relation("MeioEfetivado")
}

model Empresa {
  id        String  @id @default(uuid())
  nome      String
  ativo     Boolean @default(true)
  coberturas Cobertura[]
}

// Main Transaction
model Cobertura {
  id            String   @id @default(uuid())
  data          DateTime // Data da cobertura
  valor         Decimal  // Armazenado como Decimal, cuidado com SQLite (vai virar Float/String)
  observacao    String?
  
  // Status
  status        StatusCobertura @default(PENDENTE)
  
  // Relationships (FKs)
  postoId       String
  posto         Posto    @relation(fields: [postoId], references: [id])
  
  diaristaId    String
  diarista      Diarista @relation(fields: [diaristaId], references: [id])
  
  reservaId     String
  reserva       Reserva  @relation(fields: [reservaId], references: [id]) // Coberto
  
  motivoId      String
  motivo        Motivo   @relation(fields: [motivoId], references: [id])
  
  cargaHorariaId String
  cargaHoraria   CargaHoraria @relation(fields: [cargaHorariaId], references: [id])

  // Workflow User actors
  supervisorId  String
  supervisor    User     @relation("SupervisorLancamento", fields: [supervisorId], references: [id])
  
  // Approval Level 1
  aprovadorN1Id String?
  aprovadorN1   User?    @relation("AprovadorN1Acao", fields: [aprovadorN1Id], references: [id])
  dataAprovacaoN1 DateTime?

  // Approval Level 2 (Final) - Preserving old field for compatibility
  aprovadorId   String?
  aprovador     User?    @relation("AprovadorAcao", fields: [aprovadorId], references: [id])
  dataAprovacao DateTime?
  
  financeiroId  String?
  financeiro    User?    @relation("FinanceiroAcao", fields: [financeiroId], references: [id])
  dataPagamento DateTime?
  
  // Payment Details
  meioPagamentoSolicitadoId String
  meioPagamentoSolicitado   MeioPagamento @relation("MeioSolicitado", fields: [meioPagamentoSolicitadoId], references: [id])
  
  meioPagamentoEfetivadoId  String?
  meioPagamentoEfetivado    MeioPagamento? @relation("MeioEfetivado", fields: [meioPagamentoEfetivadoId], references: [id])

  empresaId     String?
  empresa       Empresa? @relation(fields: [empresaId], references: [id])

  // Workflow feedback loops
  ajusteSolicitado      String? // Texto do aprovador pedindo ajuste
  respostaAjuste        String? // Texto do supervisor respondendo
  justificativaReprovacao String? // Texto do aprovador ao reprovar
  justificativaPagamento  String? // Se meio efetivado != solicitado
  justificativaAprovacaoN1 String? // Parecer do Aprovador N1

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  anexos        Anexo[]
  historico     HistoricoWorkflow[]
}

// Evidence & Attachments
model Anexo {
  id          String   @id @default(uuid())
  url         String   // Path to file
  nomeOriginal String
  tamanho     Int      // Bytes
  tipo        String   // Mime type
  
  usuarioId   String
  usuario     User     @relation(fields: [usuarioId], references: [id])
  
  coberturaId String?   // Pode ser anexo de baixa (financeiro) ou lan√ßamento (supervisor)
  cobertura   Cobertura? @relation(fields: [coberturaId], references: [id])
  
  auditUpload DateTime @default(now())
  // Se precisar de soft delete ou audit de remocao, adicionar flag ativo
  ativo       Boolean  @default(true)
}

// Audit Trail
model HistoricoWorkflow {
  id           String          @id @default(uuid())
  coberturaId  String
  cobertura    Cobertura       @relation(fields: [coberturaId], references: [id])
  
  deStatus     StatusCobertura?
  paraStatus   StatusCobertura
  
  usuarioId    String
  usuario      User            @relation(fields: [usuarioId], references: [id])
  
  data         DateTime        @default(now())
  observacao   String?         // Texto livre de log ou snapshot de alteracao
}
